<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="css/formatting.css">
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="globals.js"></script>
    <script type="text/javascript" src="sourceGetter.js"></script>
    <script type="text/javascript" src="ovScraper.js"></script>
    <script type="text/javascript" src="tableFilling.js"></script>
    <script type="text/javascript" src="reportScraper.js"></script>
    <script type="text/javascript" src="totalsScraper.js"></script>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="http://jquery-csv.googlecode.com/git/src/jquery.csv.js"></script>
    <script type="text/javascript" src="js/jquery.ajax-cross-origin.min.js"></script>
</head>



<body>


    <center>
        <p id="top-heading">
            Erowid Experience Vaults Visualization
        </p>
        <p id="top-subheading">
            Scraper
        </p>

        <hr>

        <p id="top-links">
            <a href="index.html">Main Page</a>&nbsp;&nbsp;&nbsp;
            <a href="scraper.html">Scraper</a>&nbsp;&nbsp;&nbsp;
            <a href="viz.html">Visualizations</a>&nbsp;&nbsp;&nbsp;
        </p>

        <hr>First scrape the option values (when the chart shows up, it is complete), then scrape the reports (will take up to an hour to completely fill in), or scrape the totals.

        <hr>
    </center>


    <div id="progressBar" style="height:90px;  width: 500; display: inline-block;">
    </div>
    <br>

    <div style="height:550px;  width:20%; overflow-y: scroll; display: inline-block;">
        <button onclick="eevv.optionValues()">
            Scrape Option Values
        </button>
        <table id='outTable'></table>
    </div>

    <div style="height:550px; width:50%; overflow-y: scroll; display: inline-block;">
        <button onclick="eevv.scrapeReports()">
            Scrape Reports
        </button>
        <table id='reportTable'></table>
    </div>

    <div style="height:550px; width:20%; overflow-y: scroll; display: inline-block;">
        <button onclick="eevv.scrapeTotals()">
            Scrape Totals
        </button>
        <table id='totalsTable'></table>
    </div>





    <script type="text/javascript">




         //not using right nah
        function exportToCSV() {
            var csvData = new Array();
            csvData.push('"reportid",drugs","categories","nonsubstance","context","dosemethod","intensity","gender"');
            //console.log(reportArrays.length);

            var keys = [];
            for (var key in reportArrays) {
                if (reportArrays.hasOwnProperty(key)) {
                    csvData.push('"' + key + '","' + reportArrays[key].drugs + '","' + reportArrays[key].category + '","' + reportArrays[key].nonSubstance + '","' + reportArrays[key].context + '","' + reportArrays[key].doseMethod + '","' + reportArrays[key].intensity + '","' + reportArrays[key].gender + '"');
                }
            }

            var buffer = csvData.join("\n");
            var uri = "data:text/csv;charset=utf8," + encodeURIComponent(buffer);
            var fileName = "data.csv";
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                link.setAttribute("href", uri);
                link.setAttribute("download", fileName);
            } else if (navigator.msSaveBlob) { // IE 10+
                link.addEventListener("click", function (event) {
                    var blob = new Blob([buffer], {
                        "type": "text/csv;charset=utf-8;"
                    });
                    navigator.msSaveBlob(blob, fileName);
                }, false);
            } else {
                // it needs to implement server side export
                link.setAttribute("href", "http://www.example.com/export");
            }
            link.innerHTML = "Download CSV";
            link.setAttribute("id", "csvlink")
            document.body.appendChild(link);

            document.getElementById('csvlink').click();
        }









         ///older junk

        function makePercentages() {
            $.ajax({
                url: "topdrugdata.csv",
                async: false,
                success: function (csvd) {
                    data = $.csv2Array(csvd);
                },
                dataType: "text",
                complete: function () {

                    //get rid of titles (drug, amount)
                    //                    data.splice(0, 1);

                    //convert string of amounts into actual numbers
                    for (var i = 1; i < data.length; i++) {
                        data[i][1] = Number(data[i][1]);
                        data[i][2] = Number(data[i][2]);
                        data[i][3] = Number(data[i][3]);
                        data[i][4] = Number(data[i][4]);
                        data[i][5] = Number(data[i][5]);
                        data[i][6] = Number(data[i][6]);
                        data[i][7] = Number(data[i][7]);
                    }

                    //sort them from highest to lowest
                    //                    data.sort(sortFunction);

                    //                    function sortFunction(a, b) {
                    //                        if (a[1] === b[1]) {
                    //                            return 0;
                    //                        } else {
                    //                            return (a[1] > b[1]) ? -1 : 1;
                    //                        }
                    //                    }



                    console.log(data);

                    var csvData = new Array();
                    csvData.push('"drug","amount","badtrip","mystical","addiction","alone","smallgroup","largegroup"');

                    function makeIntoPercent(num) {
                        return (Math.round(10000 * num) / 100);

                    }

                    for (var j = 1; j < data.length; j++) {
                        csvData.push('"' + data[j][0] + '","' + data[j][1] + '","' + makeIntoPercent(data[j][2] / data[j][1]) + '","' + makeIntoPercent(data[j][3] / data[j][1]) + '","' + makeIntoPercent(data[j][4] / data[j][1]) + '","' + makeIntoPercent(data[j][5] / data[j][1]) + '","' + makeIntoPercent(data[j][6] / data[j][1]) + '","' + makeIntoPercent(data[j][7] / data[j][1]) + '"');
                    }

                    var buffer = csvData.join("\n");
                    var uri = "data:text/csv;charset=utf8," + encodeURIComponent(buffer);
                    var fileName = "data.csv";
                    var link = document.createElement("a");
                    if (link.download !== undefined) { // feature detection
                        // Browsers that support HTML5 download attribute
                        link.setAttribute("href", uri);
                        link.setAttribute("download", fileName);
                    } else if (navigator.msSaveBlob) { // IE 10+
                        link.addEventListener("click", function (event) {
                            var blob = new Blob([buffer], {
                                "type": "text/csv;charset=utf-8;"
                            });
                            navigator.msSaveBlob(blob, fileName);
                        }, false);
                    } else {
                        // it needs to implement server side export
                        link.setAttribute("href", "http://www.example.com/export");
                    }
                    link.innerHTML = "Download CSV";
                    document.body.appendChild(link);
                }
            });

        }




        function exportRestToCSV() {
            var csvData = new Array();
            csvData.push('"drug","amount","badtrip","mystical","addiction","alone","smallgroup","largegroup"');

            for (var j = 0; j < drugTotalsList.length; j++) {
                csvData.push('"' + drugTotalsList[j].drug + '","' + drugTotalsList[j].amount + '","' + drugTotalsList[j].badtrip + '","' + drugTotalsList[j].mystical + '","' + drugTotalsList[j].addiction + '","' + drugTotalsList[j].alone + '","' + drugTotalsList[j].smallgroup + '","' + drugTotalsList[j].largegroup + '"');
            }

            var buffer = csvData.join("\n");
            var uri = "data:text/csv;charset=utf8," + encodeURIComponent(buffer);
            var fileName = "data.csv";
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                link.setAttribute("href", uri);
                link.setAttribute("download", fileName);
            } else if (navigator.msSaveBlob) { // IE 10+
                link.addEventListener("click", function (event) {
                    var blob = new Blob([buffer], {
                        "type": "text/csv;charset=utf-8;"
                    });
                    navigator.msSaveBlob(blob, fileName);
                }, false);
            } else {
                // it needs to implement server side export
                link.setAttribute("href", "http://dreamlo.com/lb/56e7663c6e51b609ec73e9f8/json");
            }
            link.innerHTML = "Download CSV";
            document.body.appendChild(link);

        }
    </script>



</body>

</html>
